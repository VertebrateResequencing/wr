<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>WR Status</title>
        
        <!-- jQuery for various utility, and needed by bootstrap.js -->
        <script src="/js/jquery-2.2.4.min.js"></script>
        
        <!-- Bootstrap for presentation and styling -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/css/bootstrap-3.3.7.min.css">
        <script src="/js/bootstrap-3.3.7.min.js"></script>
        
        <!-- Knockout for event handling -->
        <script src="/js/knockout-3.4.0.min.js"></script>
        
        <!-- Knockstrap to make buttons and things work 2-way between knockout and bootstrap -->
        <script src="/js/knockstrap-1.3.2.min.js"></script>
        
        <!-- Some of our own general helper functions -->
        <script src="/js/wr-0.0.1.js"></script>
        <link rel="stylesheet" href="/css/wr-0.0.1.css">
    </head>
    <body>
    
        <div id="nav" class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <span class="navbar-brand">WR Status</span>
                </div>
            </div>
        </div>
        
        <div id="status" class="container">
            <div id="statuserrors" data-bind="foreach: statuserror">
                <div class="alert alert-danger fade in">
                    <p data-bind="text: $data"></p>
                </div>
            </div>
            
            <div style="width: 100%;" class="well well-sm top-margin">
                <div style="margin: 0 auto;">
                    <h5 style="margin: 0; padding: 0">Incomplete <span class="badge" data-bind="text: inflight.total"></span></h5>
                    <div class="top-margin" data-bind="if: inflight.total() > 0">
                        <div class="progress" style="margin-bottom: 0">
                            <div class="progress-bar progress-bar-striped active progress-bar-warning" role="progressbar" data-bind="style: { width: inflight.delayPct() + '%' }">
                                <!-- ko if: inflight.delayed() > 0 -->
                                    <span data-bind="text: inflight.delayed"></span> delayed
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active progress-bar-warning" role="progressbar" data-bind="style: { width: inflight.dependentPct() + '%' }">
                                <!-- ko if: inflight.dependent() > 0 -->
                                    <span data-bind="text: inflight.dependent"></span> dependent
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active progress-bar-info" role="progressbar" data-bind="style: { width: inflight.readyPct() + '%' }">
                                <!-- ko if: inflight.ready() > 0 -->
                                    <span data-bind="text: inflight.ready"></span> pending
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active" role="progressbar" data-bind="style: { width: inflight.runPct() + '%' }">
                                <!-- ko if: inflight.running() > 0 -->
                                    <span data-bind="text: inflight.running"></span> running
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-danger" role="progressbar" data-bind="style: { width: inflight.buryPct() + '%' }">
                                <!-- ko if: inflight.buried() > 0 -->
                                    <span data-bind="text: inflight.buried"></span> buried
                                <!-- /ko -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- *** not yet implemented
            <div class="row bottom-margin">
                <div class="col-xs-5">
                    <form data-bind="submit: requestRepGroup">
                        <div class="input-group">
                            <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter an identifier to also see the status of all commands added with that identifier.">identifier</span>
                            <input type="text" class="form-control" data-bind="value: repGroup">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="submit"><span class="glyphicon glyphicon-play-circle"></span></button>
                            </span>
                        </div>
                    </form>
                </div>
            </div>
            -->
            
            <!-- ko if: sortableRepGroups().length > 0 -->
                <hr>
            <!-- /ko -->
             
            <div data-bind="foreach: sortableRepGroups().sort(function(l,r) { return l.id > r.id ? 1 : -1 })">
                <div style="width: 100%;" class="well well-sm">
                    <div style="margin: 0 auto;">
                        <h5 style="margin: 0; padding: 0"><span data-bind="text: id"></span> <span class="badge" data-bind="text: total"></span></h5>
                        <div class="top-margin" data-bind="if: total() > 0">
                            <div class="progress" style="margin-bottom: 0">
                                <div class="progress-bar progress-bar-striped active progress-bar-warning clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: delayPct() + '%' }, click: $parent.showRepgroupDelayed, attr: { 'aria-valuenow': delayPct() }">
                                    <!-- ko if: delayed() > 0 -->
                                        <span data-bind="text: delayed"></span> delayed
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active progress-bar-warning clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: dependentPct() + '%' }, click: $parent.showRepgroupDependent, attr: { 'aria-valuenow': dependentPct() }">
                                    <!-- ko if: dependent() > 0 -->
                                        <span data-bind="text: dependent"></span> dependent
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active progress-bar-info clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: readyPct() + '%' }, click: $parent.showRepgroupReady, attr: { 'aria-valuenow': readyPct() }">
                                    <!-- ko if: ready() > 0 -->
                                        <span data-bind="text: ready"></span> pending
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: runPct() + '%' }, click: $parent.showRepgroupRunning, attr: { 'aria-valuenow': runPct() }">
                                    <!-- ko if: running() > 0 -->
                                        <span data-bind="text: running"></span> running
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-danger clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: buryPct() + '%' }, click: $parent.showRepgroupBuried, attr: { 'aria-valuenow': buryPct() }">
                                    <!-- ko if: buried() > 0 -->
                                        <span data-bind="text: buried"></span> buried
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: deletePct() + '%' }, attr: { 'aria-valuenow': deletePct() }">
                                    <!-- ko if: deleted() > 0 -->
                                        <span data-bind="text: deleted"></span> deleted
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-success clickable" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="style: { width: completePct() + '%' }, click: $parent.showRepgroupComplete, attr: { 'aria-valuenow': completePct() }">
                                    <!-- ko if: complete() > 0 -->
                                        <span data-bind="text: complete"></span> complete
                                    <!-- /ko -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- ko foreach: details -->
                            <div class="top-margin panel" style="margin-bottom: 0" data-bind="css: { 'panel-warning': State == 'delayed' || State == 'dependent', 'panel-info': State == 'ready', 'panel-primary': State == 'running', 'panel-danger': State == 'buried', 'panel-success': State == 'complete' }">
                                <div class="panel-heading">
                                    <h5 style="margin: 0; padding: 0" data-bind="text: Cmd"></h5>
                                    <div style="overflow-x: auto">
                                        <small><i><span data-bind="text: CwdBase"></span><span data-bind="text: Cwd" style="color: grey"></span></i></small>
                                    </div>
                                    <!-- ko if: Mounts -->
                                        <div style="overflow-x: auto">
                                            <small><i>mounts: <span data-bind="text: Mounts"></span></i></small>
                                        </div>
                                    <!-- /ko -->
                                </div>
                                <div class="panel-body keyvals">
                                    <dl>
                                        <dt>Attempts</dt>
                                        <dd data-bind="text: Attempts"></dd>
                                    </dl>
                                    <dl>
                                        <dt>Expected RAM</dt>
                                        <dd data-bind="text: ExpectedRAM.mbIEC()"></dd>
                                    </dl>
                                    <dl>
                                        <dt>Expected Time</dt>
                                        <dd data-bind="text: ExpectedTime.toDuration()"></dd>
                                    </dl>
                                    <!-- ko if: RequestedDisk > 0 -->
                                        <dl>
                                            <dt>Requested Disk</dt>
                                            <dd><span data-bind="text: RequestedDisk"></span> GB</dd>
                                        </dl>
                                    <!-- /ko -->
                                    <dl>
                                        <dt>Cores</dt>
                                        <dd data-bind="text: Cores"></dd>
                                    </dl>
                                    <!-- ko if: FailReason -->
                                        <dl>
                                            <!-- ko if: State == 'running' -->
                                                <dt>Previous Failure</dt>
                                            <!-- /ko -->
                                            <!-- ko if: State != 'running' -->
                                                <dt>Reason for Failure</dt>
                                            <!-- /ko -->
                                            <dd data-bind="text: FailReason"></dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: Exited -->
                                        <dl>
                                            <dt>Exit code</dt>
                                            <dd data-bind="text: Exitcode"></dd>
                                        </dl>
                                        <!-- ko if: Exitcode != 0 -->
                                            <dl>
                                                <dt>StdOut</dt>
                                                <dd>
                                                    <!-- ko if: StdOut -->
                                                        <span class="clickable" data-bind="click: $root.showStd.bind($data, 'StdOut')">&lt;show&gt;</span>
                                                    <!-- /ko -->
                                                    <!-- ko if: ! StdOut -->
                                                        &lt;none&gt;
                                                    <!-- /ko -->
                                                </dd>
                                            </dl>
                                            <dl>
                                                <dt>StdErr</dt>
                                                <dd>
                                                    <!-- ko if: StdErr -->
                                                        <span class="clickable" data-bind="click: $root.showStd.bind($data, 'StdErr')">&lt;show&gt;</span>
                                                    <!-- /ko -->
                                                    <!-- ko if: ! StdErr -->
                                                        &lt;none&gt;
                                                    <!-- /ko -->
                                                </dd>
                                            </dl>
                                        <!-- /ko -->
                                        <dl>
                                            <dt>Peak RAM</dt>
                                            <dd data-bind="text: PeakRAM.mbIEC()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Started</dt>
                                            <dd data-bind="text: Started.toDate()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Ended</dt>
                                            <dd data-bind="text: Ended.toDate()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Walltime</dt>
                                            <dd data-bind="text: Walltime.toDuration()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>CPUtime</dt>
                                            <dd data-bind="text: CPUtime.toDuration()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Host</dt>
                                            <dd data-bind="text: Host"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Pid</dt>
                                            <dd data-bind="text: Pid"></dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: ! Exited && (State == "reserved" || State == "running") -->
                                        <dl>
                                            <dt>Started</dt>
                                            <dd data-bind="text: Started.toDate()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Walltime</dt>
                                            <dd data-bind="text: Walltime.toDuration()"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Host</dt>
                                            <dd data-bind="text: Host"></dd>
                                        </dl>
                                        <dl>
                                            <dt>Pid</dt>
                                            <dd data-bind="text: Pid"></dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: ! Exited && State == "buried" && StdErr -->
                                        <dl>
                                            <dt>StdErr</dt>
                                            <dd>
                                                <span class="clickable" data-bind="click: $root.showStd.bind($data, 'StdErr')">&lt;show&gt;</span>
                                            </dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: DepGroups -->
                                        <dl>
                                            <dt>DepGroups</dt>
                                            <dd>
                                                <span class="clickable" data-bind="click: $root.showDepGroups">&lt;show&gt;</span>
                                            </dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: Dependencies -->
                                        <dl>
                                            <dt>Dependencies</dt>
                                            <dd>
                                                <span class="clickable" data-bind="click: $root.showDependencies">&lt;show&gt;</span>
                                            </dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <dl>
                                        <dt>Env</dt>
                                        <dd>
                                            <span class="clickable" data-bind="click: $root.showEnv">&lt;show&gt;</span>
                                        </dd>
                                    </dl>
                                    
                                    <!-- ko if: Cwd -->
                                        <dl>
                                            <dt>Home Changed</dt>
                                            <dd data-bind="text: HomeChanged"></dd>
                                        </dl>
                                    <!-- /ko -->
                                    
                                    <!-- ko if: Behaviours -->
                                        <dl>
                                            <dt>Behaviours</dt>
                                            <dd>
                                                <span class="clickable" data-bind="click: $root.showBehaviours">&lt;show&gt;</span>
                                            </dd>
                                        </dl>
                                    <!-- /ko -->
                                </div>
                                <div class="panel-footer clearfix">
                                    <!-- ko if: Similar -->
                                        + <span data-bind="text: Similar"></span> other commands
                                        <!-- ko if: Exited && Exitcode != 0 -->
                                            with same exit code (<span data-bind="text: Exitcode"></span>) and reason for failure
                                        <!-- /ko -->
                                    <!-- /ko -->
                                    <!-- ko if: State == "delayed" -->
                                        <button type="button" class="btn btn-danger pull-right" data-bind="click: $root.confirmRemoveDelay">Remove</button>
                                    <!-- /ko -->
                                    <!-- ko if: State == "ready" -->
                                        <button type="button" class="btn btn-danger pull-right" data-bind="click: $root.confirmRemovePend">Remove</button>
                                    <!-- /ko -->
                                    <!-- ko if: State == "dependent" -->
                                        <button type="button" class="btn btn-danger pull-right" data-bind="click: $root.confirmRemoveDep">Remove</button>
                                    <!-- /ko -->
                                    <!-- ko if: State == "buried" -->
                                        <div class="btn-group pull-right">
                                            <button type="button" class="btn btn-danger" data-bind="click: $root.confirmRemoveFail">Remove</button>
                                            <button type="button" class="btn btn-primary" data-bind="click: $root.confirmRetry">Retry</button>
                                        </div>
                                    <!-- /ko -->
                                </div>
                            </div>
                        <!-- /ko -->
                    </div>
                </div>
            </div>
            
            <!-- action modals -->
            <div data-bind="modal: {
                visible: actionModalVisible,
                dialogCss: 'modal-sm',
                header: { data: { label: actionModalHeader } },
                body: { name: 'actionModalBodyTemplate', data: actionDetails },
                footer: { name: 'actionModalFooterTemplate', data: actionDetails }
            }"></div>
            <script type="text/html" id="actionModalBodyTemplate">
                Are you sure you want to <span data-bind="text: action"></span> the <span data-bind="text: count"></span> commands with the identifier "<span data-bind="text: repGroup"></span>"
                <!-- ko if: exited -->
                    that had exit code <span data-bind="text: exitCode"></span> and failed because "<span data-bind="text: failReason"></span>"?
                <!-- /ko -->
                <!-- ko if: ! exited -->
                    ?
                <!-- /ko -->
                <small>(removal of commands that have other commands depending on them will silently fail)</small>
            </script>
            <script type="text/html" id="actionModalFooterTemplate">
                <div class="btn-group">
                    <!-- ko if: count() > 1 -->
                        <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, true), text: action().capitalizeFirstLetter() + ' all'"></button>
                        <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, false), text: action().capitalizeFirstLetter() + ' 1'"></button>
                    <!-- /ko -->
                    <!-- ko if: count() == 1 -->
                        <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, false), text: action().capitalizeFirstLetter()"></button>
                    <!-- /ko -->
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </script>
            
            <!-- stdout/err modals -->
            <div data-bind="modal: {
                visible: stdModalVisible,
                dialogCss: 'modal-lg, modal-std',
                header: { data: { label: stdModalHeader } },
                body: { data: { content: stdOutput } }
            }"></div>
            
            <!-- depgroups modal -->
            <div data-bind="modal: {
                visible: dgModalVisible,
                dialogCss: 'modal-lg',
                header: { data: { label: 'Dependency Groups' } },
                body: { name: 'envModalBodyTemplate', data: dgVars }
            }"></div>
            
            <!-- dependencies modal -->
            <div data-bind="modal: {
                visible: depModalVisible,
                dialogCss: 'modal-lg',
                header: { data: { label: 'Dependencies' } },
                body: { name: 'envModalBodyTemplate', data: depVars }
            }"></div>
            
            <!-- behaviours modal -->
            <div data-bind="modal: {
                visible: behModalVisible,
                dialogCss: 'modal-lg',
                header: { data: { label: 'Behaviours' } },
                body: { name: 'envModalBodyTemplate', data: behVars }
            }"></div>
            
            <!-- env modal -->
            <div data-bind="modal: {
                visible: envModalVisible,
                dialogCss: 'modal-lg',
                header: { data: { label: 'Environment Variables' } },
                body: { name: 'envModalBodyTemplate', data: envVars }
            }"></div>
            <script type="text/html" id="envModalBodyTemplate">
                <div data-bind="foreach: $data">
                    <span data-bind="text: $data"></span><br>
                </div>
            </script>
            
            <hr>
            
            <footer id="footer">
                <small>&copy; 2016, 2017 Genome Research Limited.</small>
            </footer>
        </div>
        
        <script type="text/javascript">
            // turn on bootstrap tooltips
            $('[data-toggle="tooltip"]').tooltip({'placement': 'top'});
            
            ko.options.deferUpdates = true;
            
            // viewmodel for displaying status
            function StatusViewModel() {
                var self = this;
                self.aquiringstatus = ko.observableArray();
                self.statuserror = ko.observableArray();
                self.repGroup = ko.observable();
                self.detailsRepgroup = '';
                self.detailsState = '';
                self.detailsOA;
                self.rateLimit = 350;
                
                self.inflight = {
                    'delayed': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'dependent': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'ready': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'running': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'buried': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'delayPct': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'dependentPct': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'readyPct': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'runPct': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'buryPct': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                    'old_total': 0,
                    'delay_compute': 0
                };
                self.inflight['total'] = ko.computed(function() {
                    if (self.inflight['delay_compute']) {
                        return self.inflight['old_total'];
                    }
                    
                    var total = self.inflight['delayed']() + self.inflight['dependent']() + self.inflight['ready']() + self.inflight['running']() + self.inflight['buried']();
                    if (total > 0) {
                        var multiplier = 100 / total;
                        // we scale to 98 to avoid a bug in bootstrap progress
                        // bars which will result in the right-most bar
                        // flickering out of existence, even though we never
                        // total over 100
                        var scaled = percentScaler([(multiplier * self.inflight['delayed']()), (multiplier * self.inflight['dependent']()), (multiplier * self.inflight['ready']()), (multiplier * self.inflight['running']()), (multiplier * self.inflight['buried']())], 98);
                        var rounded = percentRounder(scaled, 2);
                        self.inflight['delayPct'](rounded[0]);
                        self.inflight['dependentPct'](rounded[1]);
                        self.inflight['readyPct'](rounded[2]);
                        self.inflight['runPct'](rounded[3]);
                        self.inflight['buryPct'](rounded[4]);
                    }
                        
                    self.inflight['old_total'] = total;
                    return total;
                }).extend({ rateLimit: self.rateLimit });
                
                self.repGroups = [];
                self.repGroupLookup = {};
                self.sortableRepGroups = ko.observableArray();
                self.ignore = {};
                
                // set up the websocket
                if (window.WebSocket === undefined) {
                    self.statuserror.push("Your browser does not support WebSockets");
                } else {
                    self.ws = new WebSocket("ws://" + location.hostname + ":" + location.port + "/status_ws");
                    self.ws.onopen = function() {
                        self.ws.send(JSON.stringify({ Request: "current" }));
                    };
                    self.ws.onclose = function () {
                        self.statuserror.push("Connection to the manager has been lost!");
                        //*** we could poll and try to re-establish the connection...
                    }
                    self.ws.onmessage = function (e) {
                        json = JSON.parse(e.data)
                        if (json.hasOwnProperty('FromState')) {
                            // state numbers have changed
                            rg = json['RepGroup']
                            var repgroup
                            if (rg == "+all+") {
                                repgroup = self.inflight;
                            } else if (self.repGroupLookup.hasOwnProperty(rg)) {
                                repgroup = self.repGroups[self.repGroupLookup[rg]];
                            } else {
                                repgroup = {
                                    'id': rg,
                                    'delayed': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'dependent': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'ready': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'running': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'buried': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'deleted': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'complete': ko.observable(0).extend({ rateLimit: self.rateLimit }),
                                    'delayPct': ko.observable(0),
                                    'dependentPct': ko.observable(0),
                                    'readyPct': ko.observable(0),
                                    'runPct': ko.observable(0),
                                    'buryPct': ko.observable(0),
                                    'deletePct': ko.observable(0),
                                    'completePct': ko.observable(0),
                                    'details': ko.observableArray(),
                                    'old_total': 0,
                                    'delay_compute': 0
                                };
                                repgroup['total'] = ko.computed(function() {
                                    if (repgroup['delay_compute']) {
                                        return repgroup['old_total'];
                                    }
                                    
                                    var total = repgroup['delayed']() + repgroup['dependent']() + repgroup['ready']() + repgroup['running']() + repgroup['buried']() + repgroup['deleted']() + repgroup['complete']();
                                    if (total > 0) {
                                        var multiplier = 100 / total;
                                        // we scale to 98 to avoid a bug in
                                        // bootstrap progress bars which will
                                        // result in the right-most bar
                                        // flickering out of existence, even
                                        // though we never total over 100
                                        var scaled = percentScaler([(multiplier * repgroup['delayed']()), (multiplier * repgroup['dependent']()), (multiplier * repgroup['ready']()), (multiplier * repgroup['running']()), (multiplier * repgroup['buried']()), (multiplier * repgroup['deleted']()), (multiplier * repgroup['complete']())], 98);
                                        var rounded = percentRounder(scaled, 2);
                                        
                                        // to avoid the percentage bars
                                        // totalling over 100 at any point in
                                        // time, do all decrementing updates
                                        // first; not sure if this really helps
                                        // avoid some instances of flickering,
                                        // but it might...
                                        var keys = ['delayPct', 'dependentPct', 'readyPct', 'runPct', 'buryPct', 'deletePct', 'completePct'];
                                        for (var i = 0; i < 7; i++) {
                                            if (repgroup[keys[i]]() > rounded[i]) {
                                                repgroup[keys[i]](rounded[i]);
                                            }
                                        }
                                        for (var i = 0; i < 7; i++) {
                                            if (repgroup[keys[i]]() < rounded[i]) {
                                                repgroup[keys[i]](rounded[i]);
                                            }
                                        }
                                    }
                                    
                                    repgroup['old_total'] = total;
                                    return total;
                                }).extend({ rateLimit: self.rateLimit });
                                
                                self.repGroups.push(repgroup);
                                self.repGroupLookup[rg] = self.repGroups.length - 1;
                                
                                // because of our lookup, repGroup sort order
                                // must not change, but we want them displayed
                                // sorted, so we also push to an independent
                                // observableArray
                                self.sortableRepGroups.push(repgroup);
                            }
                            
                            var from, to
                            switch(json['FromState']) {
                                case 'delayed':
                                    from = repgroup['delayed'];
                                    break;
                                case 'dependent':
                                    from = repgroup['dependent'];
                                    break;
                                case 'ready':
                                    from = repgroup['ready'];
                                    break;
                                case 'running':
                                    from = repgroup['running'];
                                    break;
                                case 'buried':
                                    from = repgroup['buried'];
                                    break;
                            }
                            
                            if (self.ignore.hasOwnProperty(json['RepGroup']) && self.ignore[json['RepGroup']].hasOwnProperty(json['ToState']) && self.ignore[json['RepGroup']][json['ToState']] >= json['Count']) {
                                // ignore this 'to' transition, because things
                                // are out of order and we already accounted for
                                // it
                                self.ignore[json['RepGroup']][json['ToState']] -= json['Count'];
                                if (self.ignore[json['RepGroup']][json['ToState']] == 0) {
                                    delete self.ignore[json['RepGroup']][json['ToState']];
                                    if (Object.keys(self.ignore[json['RepGroup']]).length == 0) {
                                        delete self.ignore[json['RepGroup']];
                                    }
                                }
                            } else {
                                switch(json['ToState']) {
                                    case 'delayed':
                                        to = repgroup['delayed'];
                                        break;
                                    case 'dependent':
                                        to = repgroup['dependent'];
                                        break;
                                    case 'ready':
                                        to = repgroup['ready'];
                                        break;
                                    case 'running':
                                        to = repgroup['running'];
                                        break;
                                    case 'buried':
                                        to = repgroup['buried'];
                                        break;
                                    case 'complete':
                                        if (rg != "+all+") {
                                            to = repgroup['complete'];
                                        }
                                        break;
                                    case 'deleted':
                                        if (rg != "+all+") {
                                            to = repgroup['deleted'];
                                        }
                                        break;
                                }
                            }
                            
                            repgroup['delay_compute'] = to ? 1 : 0;
                            if (from) {
                                var newfrom = from() - json['Count'];
                                if (newfrom >= 0) {
                                    from(newfrom);
                                } else {
                                    // sometimes transitions can arrive out of
                                    // order; we'll let this one go through, and
                                    // mark to ignore the previous transition
                                    // when it comes in later
                                    if (! self.ignore.hasOwnProperty(json['RepGroup'])) {
                                        self.ignore[json['RepGroup']] = {};
                                    }
                                    if (self.ignore[json['RepGroup']].hasOwnProperty(json['FromState'])) {
                                        self.ignore[json['RepGroup']][json['FromState']] += json['Count'];
                                    } else {
                                        self.ignore[json['RepGroup']][json['FromState']] = json['Count'];
                                    }
                                    
                                    from(0);
                                }
                            }
                            repgroup['delay_compute'] = 0;
                            if (to) {
                                to(to() + json['Count']);
                            }
                        } else if (json.hasOwnProperty('State')) {
                            rg = json['RepGroup']
                            if (self.detailsOA && rg == self.detailsRepgroup) {
                                // the user has clicked on a progress bar for
                                // a particular repgroup; add to its details
                                self.detailsOA.push(json);
                            }
                        }
                    }
                }
                
                // act if the user requests a repGroup
                self.requestRepGroup = function(formElement) {
                    console.log("requesting rep group " + self.repGroup())
                    self.ws.send(JSON.stringify({ Request: 'search', RepGroup: self.repGroup() })); 
                    // *** not yet implemented in the manager, does nothing
                };
                
                // act if the user clicks on the different types of progress
                // bar for a repGroup
                self.showRepgroupDelayed = function(repGroup) {
                    self.showGroupState(repGroup, 'delayed');
                };
                self.showRepgroupDependent = function(repGroup) {
                    self.showGroupState(repGroup, 'dependent');
                };
                self.showRepgroupReady = function(repGroup) {
                    self.showGroupState(repGroup, 'ready');
                };
                self.showRepgroupRunning = function(repGroup) {
                    self.showGroupState(repGroup, 'reserved'); // which includes 'running'
                };
                self.showRepgroupBuried = function(repGroup) {
                    self.showGroupState(repGroup, 'buried');
                };
                self.showRepgroupComplete = function(repGroup) {
                    self.showGroupState(repGroup, 'complete');
                };
                self.showGroupState = function(repGroup, state) {
                    if (self.detailsOA) {
                        self.detailsOA([]);
                    }
                    
                    if (repGroup.id == self.detailsRepgroup && state == self.detailsState) {
                        // stop showing
                        repGroup.details([]);
                        self.detailsRepgroup = '';
                        self.detailsState = '';
                        self.detailsOA = '';
                        return;
                    }
                    
                    self.detailsRepgroup = repGroup.id;
                    self.detailsState = state;
                    self.detailsOA = repGroup.details;
                    self.ws.send(JSON.stringify({ Request: 'details', RepGroup: repGroup.id, State: state }));
                }
                
                // act if the user clicks to view stdout/err
                self.stdModalVisible = ko.observable(false);
                self.stdModalHeader = ko.observable();
                self.stdOutput = ko.observable();
                self.showStd = function(type, job) {
                    self.stdModalHeader(type);
                    self.stdOutput(job[type]);
                    self.stdModalVisible(true);
                }
                
                // act if the user clicks to view DepGroups
                self.dgModalVisible = ko.observable(false);
                self.dgVars = ko.observableArray();
                self.showDepGroups = function(job) {
                    self.dgVars(job.DepGroups);
                    self.dgModalVisible(true);
                }
                
                // act if the user clicks to view Dependencies
                self.depModalVisible = ko.observable(false);
                self.depVars = ko.observableArray();
                self.showDependencies = function(job) {
                    self.depVars(job.Dependencies);
                    self.depModalVisible(true);
                }
                
                // act if the user clicks to view Behaviours
                self.behModalVisible = ko.observable(false);
                self.behVars = ko.observableArray();
                self.showBehaviours = function(job) {
                    self.behVars([job.Behaviours]);
                    self.behModalVisible(true);
                }
                
                // act if the user clicks to view env
                self.envModalVisible = ko.observable(false);
                self.envVars = ko.observableArray();
                self.showEnv = function(job) {
                    self.envVars(job.Env);
                    self.envModalVisible(true);
                }
                
                // act if the user clicks one of the action buttons in the
                // details of a progress bar
                self.actionModalVisible = ko.observable(false);
                self.actionModalHeader = ko.observable();
                self.actionDetails = {
                    action: ko.observable(),
                    repGroup: ko.observable(),
                    state: ko.observable(),
                    exited: ko.observable(),
                    exitCode: ko.observable(),
                    failReason: ko.observable(),
                    count: ko.observable()
                };
                self.jobToActionDetails = function(job, action) {
                    self.actionDetails.action(action);
                    self.actionDetails.repGroup(job.RepGroup);
                    self.actionDetails.state(job.State);
                    self.actionDetails.exitCode(job.Exited);
                    self.actionDetails.exitCode(job.Exitcode);
                    self.actionDetails.failReason(job.FailReason);
                    self.actionDetails.count(job.Similar + 1);
                };
                self.commitAction = function(all) {
                    // request the action
                    self.ws.send(JSON.stringify({
                        Request: self.actionDetails.action(),
                        RepGroup: self.actionDetails.repGroup(),
                        State: self.actionDetails.state(),
                        Exitcode: self.actionDetails.exitCode(),
                        FailReason: self.actionDetails.failReason(),
                        All: all
                    }));
                    
                    // reset the ui
                    if (self.detailsOA) {
                        self.detailsOA([]);
                    }
                    self.detailsRepgroup = '';
                    self.detailsState = '';
                    self.detailsOA = '';
                    self.actionModalVisible(false);
                };
                self.confirmRetry = function(job) {
                    self.jobToActionDetails(job, 'retry');
                    self.actionModalHeader('Retry Buried Commands');
                    self.actionModalVisible(true);
                };
                self.confirmRemoveFail = function(job) {
                    self.jobToActionDetails(job, 'remove');
                    self.actionModalHeader('Remove Failed Commands');
                    self.actionModalVisible(true);
                };
                self.confirmRemoveDep = function(job) {
                    self.jobToActionDetails(job, 'remove');
                    self.actionModalHeader('Remove Dependent Commands');
                    self.actionModalVisible(true);
                };
                self.confirmRemovePend = function(job) {
                    self.jobToActionDetails(job, 'remove');
                    self.actionModalHeader('Remove Pending Commands');
                    self.actionModalVisible(true);
                };
                self.confirmRemoveDelay = function(job) {
                    self.jobToActionDetails(job, 'remove');
                    self.actionModalHeader('Remove Delayed Commands');
                    self.actionModalVisible(true);
                };
            }
            var svm = new StatusViewModel();
            ko.applyBindings(svm, $('#status')[0]);
        </script>
    </body>
</html>
