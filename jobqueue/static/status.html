<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>WR Status</title>

    <!-- jQuery for various utility, and needed by bootstrap.js -->
    <script src="/js/jquery-2.2.4.min.js"></script>

    <!-- Bootstrap for presentation and styling -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/bootstrap-3.3.7.min.css">
    <script src="/js/bootstrap-3.3.7.min.js"></script>

    <!-- Knockout for event handling -->
    <script src="/js/knockout-3.4.0.min.js"></script>

    <!-- Knockstrap to make buttons and things work 2-way between knockout and bootstrap -->
    <script src="/js/knockstrap-1.3.2.min.js"></script>

    <!-- Import utility functions for template access -->
    <script>
        // Store the utility functions so they're accessible from templates
        window.wrUtils = {};
    </script>

    <!-- Main entry point for the status page (which imports all other modules) -->
    <script src="/js/wr/main.js" type="module"></script>

    <link rel="stylesheet" href="/css/wr-0.36.0.css">

    <!-- Hide content until Knockout initializes -->
    <style>
        #status {
            visibility: hidden;
        }

        body.ko-initialized #status {
            visibility: visible;
        }
    </style>

    <!-- Chart.js for resource visualizations -->
    <script src="/js/chart-3.9.1.min.js"></script>
    <script src="/js/chartjs-chart-boxplot-4.4.4.min.js"></script>
    <script>
        // Register the boxplot controller
        window.chartRegistered = false;
        function ensureChartTypesRegistered() {
            if (!window.chartRegistered && typeof Chart !== 'undefined') {
                if (window.ChartBoxPlot) {
                    Chart.register(ChartBoxPlot.BoxPlotController, ChartBoxPlot.BoxAndWiskers);
                    window.chartRegistered = true;
                }
            }
        }

        // Try to register immediately if Chart is loaded
        if (typeof Chart !== 'undefined') {
            ensureChartTypesRegistered();
        }

        // Also try again on window load to be sure
        window.addEventListener('load', ensureChartTypesRegistered);
    </script>

</head>

<body>
    <!-- ====================== NAVIGATION BAR ====================== -->
    <div id="nav" class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <span class="navbar-brand">WR Status</span>
            </div>
        </div>
    </div>

    <div id="status" class="container">
        <!-- ====================== ERROR MESSAGES SECTION ====================== -->
        <div id="statuserrors" data-bind="foreach: statuserror">
            <div class="alert alert-danger fade in">
                <p data-bind="text: $data"></p>
            </div>
        </div>

        <!-- ====================== BAD SERVERS SECTION ====================== -->
        <div id="badservers" data-bind="foreach: badservers">
            <div class="alert alert-danger fade in">
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        Server
                        <!-- ko if: Problem == "" -->
                        <u class="dotted"
                            data-bind="tooltip: { title: 'If this is just a temporary connectivity issue, this message will go away by itself.' }">might
                            be dead</u>
                        <!-- /ko -->
                        <!-- ko if: !Problem == "" -->
                        <u class="dotted"
                            data-bind="tooltip: { title: 'There was a problem using this server. It will not be used to run other jobs. Investigate it manually if you like, before hitting the `Kill it` button.' }">is
                            no longer usable</u>
                        <!-- /ko -->
                    </div>
                    <div class="panel-body">
                        Name: <span data-bind="text: Name"></span><br>
                        ID: <span data-bind="text: ID"></span><br>
                        IP: <span data-bind="text: IP"></span><br>
                        <!-- ko if: Problem == "" -->
                        Lost contact: <span data-bind="text: window.wrUtils.toDate(Date)"></span>
                        <button type="button" class="btn btn-danger pull-right"
                            data-bind="click: $root.confirmDeadServer">It's really dead</button>
                        <!-- /ko -->
                        <!-- ko if: !Problem == "" -->
                        Problem encountered: <span data-bind="text: Problem"></span><br>
                        Problem encountered at: <span data-bind="text: window.wrUtils.toDate(Date)"></span>
                        <button type="button" class="btn btn-danger pull-right"
                            data-bind="click: $root.confirmDeadServer">Kill it</button>
                        <!-- /ko -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ====================== SYSTEM MESSAGES SECTION ====================== -->
        <!-- ko if: messages().length > 1 -->
        <button type="button" class="btn btn-warning pull-right" data-bind="click: $root.dismissMessages">Dismiss
            All</button>
        <!-- /ko -->
        <!-- ko if: messages().length > 0 -->
        <div class="alert alert-danger fade in">
            <div id="messages" data-bind="foreach: messages">
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        Scheduler Issue
                        <!-- ko if: Count() > 1 -->
                        [first reported at: <span data-bind="text: window.wrUtils.toDate(FirstDate)"></span>]
                        <!-- /ko -->
                    </div>
                    <div class="panel-body">
                        <span data-bind="text: Msg"></span><br>
                        Reported at: <span data-bind="text: window.wrUtils.toDate(LastDate())"></span>
                        <!-- ko if: Count() > 1 -->
                        <br>Reported: <span data-bind="text: Count"></span> times
                        <!-- /ko -->
                        <button type="button" class="btn btn-warning pull-right"
                            data-bind="click: $root.dismissMessage">Dismiss</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- /ko -->

        <!-- ====================== JOB SEARCH SECTION ====================== -->
        <div class="well well-sm top-margin">
            <form data-bind="submit: searchJobs">
                <div class="input-group">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-search"></span>
                    </span>
                    <input type="text" class="form-control" placeholder="Search for jobs by RepGroup identifier"
                        data-bind="value: searchRepGroup, valueUpdate: 'afterkeydown', disable: isSearchLoading">
                    <span class="input-group-addon">
                        <label class="checkbox-inline">
                            <input type="checkbox" data-bind="checked: searchIsSubstring, disable: isSearchLoading">
                            match substrings
                        </label>
                    </span>
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="submit" data-bind="disable: isSearchLoading">
                            <!-- ko if: !isSearchLoading() -->
                            <span class="glyphicon glyphicon-search"></span> Search
                            <!-- /ko -->
                            <!-- ko if: isSearchLoading() -->
                            <span class="loader"></span> Searching...
                            <!-- /ko -->
                        </button>
                        <button class="btn btn-default" type="button"
                            data-bind="click: clearSearch, disable: isSearchLoading() || !hasSearched()">
                            <span class="glyphicon glyphicon-remove"></span> Clear
                        </button>
                        <button class="btn btn-default" type="button"
                            data-bind="click: toggleSearchMinimized, disable: isSearchLoading() || !hasSearched() || searchSummaries().length === 0">
                            <span class="glyphicon"
                                data-bind="css: { 'glyphicon-chevron-up': !searchMinimized(), 'glyphicon-chevron-down': searchMinimized }"></span>
                        </button>
                    </span>
                </div>
            </form>

            <!-- Search results container (only shown when not minimized) -->
            <div data-bind="if: searchSummaries().length > 0 && !searchMinimized()" class="top-margin">
                <h5><span data-bind="text: searchResults().length"></span> jobs found across <span
                        data-bind="text: searchSummaries().length - (searchSummaries().length > 1 ? 1 : 0)"></span>
                    RepGroups
                </h5>

                <!-- RepGroup Summaries - Styled like the main REP GROUP SECTION -->
                <div data-bind="foreach: searchSummaries">
                    <div style="width: 100%;" class="well well-sm search-result-repgroup">
                        <h5 style="margin: 0; padding: 0">
                            <span data-bind="text: name"></span>
                            <span class="badge state-filter clickable" data-bind="text: total, 
                                           css: { 'selected-state': selectedState() === 'total' },
                                           click: function() { $parent.setSelectedState($data, 'total') }"></span>

                            <!-- Show jobs button -->
                            <button type="button" class="btn btn-xs btn-primary pull-right"
                                data-bind="click: function() { $parent.showGroupJobs($data) }">
                                <span class="glyphicon glyphicon-list"></span>
                                <span
                                    data-bind="text: 'Show ' + (selectedState() === 'total' ? 'All' : selectedState()) + ' Jobs'"></span>
                            </button>
                        </h5>

                        <div class="top-margin" data-bind="if: total > 0">
                            <div class="progress" style="margin-bottom: 0">
                                <div class="progress-bar progress-bar-striped active progress-bar-warning state-filter"
                                    role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.delayed > 0, 'selected-state': selectedState() === 'delayed' }, 
                                              style: { width: (counts.delayed/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.delayed/total*100 },
                                              click: function() { if (counts.delayed > 0) $parent.setSelectedState($data, 'delayed') }">
                                    <!-- ko if: counts.delayed > 0 -->
                                    <span data-bind="text: counts.delayed"></span> delayed
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active progress-bar-warning state-filter"
                                    role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.dependent > 0, 'selected-state': selectedState() === 'dependent' }, 
                                              style: { width: (counts.dependent/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.dependent/total*100 },
                                              click: function() { if (counts.dependent > 0) $parent.setSelectedState($data, 'dependent') }">
                                    <!-- ko if: counts.dependent > 0 -->
                                    <span data-bind="text: counts.dependent"></span> dependent
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active progress-bar-info state-filter"
                                    role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.ready > 0, 'selected-state': selectedState() === 'ready' }, 
                                              style: { width: (counts.ready/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.ready/total*100 },
                                              click: function() { if (counts.ready > 0) $parent.setSelectedState($data, 'ready') }">
                                    <!-- ko if: counts.ready > 0 -->
                                    <span data-bind="text: counts.ready"></span> pending
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active state-filter" role="progressbar"
                                    aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.running > 0, 'selected-state': selectedState() === 'running' }, 
                                              style: { width: (counts.running/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.running/total*100 },
                                              click: function() { if (counts.running > 0) $parent.setSelectedState($data, 'running') }">
                                    <!-- ko if: counts.running > 0 -->
                                    <span data-bind="text: counts.running"></span> running
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-striped active progress-bar-danger state-filter"
                                    role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.lost > 0, 'selected-state': selectedState() === 'lost' }, 
                                              style: { width: (counts.lost/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.lost/total*100 },
                                              click: function() { if (counts.lost > 0) $parent.setSelectedState($data, 'lost') }">
                                    <!-- ko if: counts.lost > 0 -->
                                    <span data-bind="text: counts.lost"></span> lost contact
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-danger state-filter" role="progressbar"
                                    aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.buried > 0, 'selected-state': selectedState() === 'buried' }, 
                                              style: { width: (counts.buried/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.buried/total*100 },
                                              click: function() { if (counts.buried > 0) $parent.setSelectedState($data, 'buried') }">
                                    <!-- ko if: counts.buried > 0 -->
                                    <span data-bind="text: counts.buried"></span> buried
                                    <!-- /ko -->
                                </div>
                                <div class="progress-bar progress-bar-success state-filter" role="progressbar"
                                    aria-valuemin="0" aria-valuemax="100"
                                    data-bind="css: { 'clickable': counts.complete > 0, 'selected-state': selectedState() === 'complete' }, 
                                              style: { width: (counts.complete/total*100) + '%' }, 
                                              attr: { 'aria-valuenow': counts.complete/total*100 },
                                              click: function() { if (counts.complete > 0) $parent.setSelectedState($data, 'complete') }">
                                    <!-- ko if: counts.complete > 0 -->
                                    <span data-bind="text: counts.complete"></span> complete
                                    <!-- /ko -->
                                </div>
                            </div>
                        </div>

                        <!-- Resources and execution data - using original format but with computed stats -->
                        <!-- ko with: $parent.getFilteredJobStats($data, selectedState()) -->
                        <div class="panel-body compact-props" data-bind="if: hasData || timeline.started">
                            <table class="prop-table">
                                <!-- Resources section -->
                                <tr class="prop-row"
                                    data-bind="visible: hasData && ($parent.selectedState() === 'total' || $parent.selectedState() === 'buried' || $parent.selectedState() === 'complete')">
                                    <td class="prop-title">Resources:</td>
                                    <td class="prop-content">
                                        <div class="prop-tag resource-chart-trigger" data-bind="visible: resources.memory.avg > 0, 
                     click: function() { $root.showResourceChart('memory', $parent, $data) }">
                                            <span class="prop-name">Memory</span>
                                            <span class="prop-value">
                                                <span
                                                    data-bind="text: window.wrUtils.mbIEC(resources.memory.avg)"></span>
                                                <!-- ko if: resources.memory.stdDev > 0 -->
                                                <span class="prop-separator">±</span>
                                                <span
                                                    data-bind="text: window.wrUtils.mbIEC(resources.memory.stdDev)"></span>
                                                <!-- /ko -->
                                                <i class="glyphicon glyphicon-stats"
                                                    style="margin-left: 4px; font-size: 10px; opacity: 0.6;"></i>
                                            </span>
                                        </div>

                                        <div class="prop-tag resource-chart-trigger" data-bind="visible: resources.disk.avg > 0,
                     click: function() { $root.showResourceChart('disk', $parent, $data) }">
                                            <span class="prop-name">Disk</span>
                                            <span class="prop-value">
                                                <span data-bind="text: window.wrUtils.mbIEC(resources.disk.avg)"></span>
                                                <!-- ko if: resources.disk.stdDev > 0 -->
                                                <span class="prop-separator">±</span>
                                                <span
                                                    data-bind="text: window.wrUtils.mbIEC(resources.disk.stdDev)"></span>
                                                <!-- /ko -->
                                                <i class="glyphicon glyphicon-stats"
                                                    style="margin-left: 4px; font-size: 10px; opacity: 0.6;"></i>
                                            </span>
                                        </div>

                                        <!-- Combined Time property that replaces separate Wall Time and CPU Time -->
                                        <div class="prop-tag resource-chart-trigger" data-bind="visible: resources.walltime.avg > 0 || resources.cputime.avg > 0,
                                            click: function() { $root.showResourceChart('time', $parent, $data) }">
                                            <span class="prop-name">Time</span>
                                            <span class="prop-value">
                                                <!-- Wall Time section -->
                                                <span
                                                    data-bind="text: 'Wall: ' + window.wrUtils.toDuration(resources.walltime.avg)"></span>
                                                <!-- ko if: resources.walltime.stdDev > 0 -->
                                                <span class="prop-separator">±</span>
                                                <span
                                                    data-bind="text: window.wrUtils.toDuration(resources.walltime.stdDev)"></span>
                                                <!-- /ko -->

                                                <!-- Separator between Wall and CPU -->
                                                <span class="prop-separator">•</span>

                                                <!-- CPU Time section -->
                                                <span
                                                    data-bind="text: 'CPU: ' + window.wrUtils.toDuration(resources.cputime.avg)"></span>
                                                <!-- ko if: resources.cputime.stdDev > 0 -->
                                                <span class="prop-separator">±</span>
                                                <span
                                                    data-bind="text: window.wrUtils.toDuration(resources.cputime.stdDev)"></span>
                                                <!-- /ko -->

                                                <i class="glyphicon glyphicon-stats"
                                                    style="margin-left: 4px; font-size: 10px; opacity: 0.6;"></i>
                                            </span>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Timeline section - also make it clickable -->
                                <tr class="prop-row"
                                    data-bind="visible: timeline.started && ($parent.selectedState() === 'total' || $parent.selectedState() === 'buried' || $parent.selectedState() === 'complete')">
                                    <td class="prop-title">Execution:</td>
                                    <td class="prop-content">
                                        <div class="prop-tag resource-chart-trigger" data-bind="visible: timeline.started,
                 click: function() { $root.showResourceChart('execution', $parent, $data) }">
                                            <span class="prop-name">When</span>
                                            <span class="prop-value">
                                                <span
                                                    data-bind="text: 'Started: ' + (timeline.started ? window.wrUtils.toDate(timeline.started) : 'Unknown')"></span>
                                                <!-- ko if: timeline.ended -->
                                                <span class="prop-separator">→</span>
                                                <span
                                                    data-bind="text: 'Ended: ' + window.wrUtils.toDate(timeline.ended)"></span>
                                                <!-- /ko -->
                                                <i class="glyphicon glyphicon-stats"
                                                    style="margin-left: 4px; font-size: 10px; opacity: 0.6;"></i>
                                            </span>
                                        </div>

                                        <div class="prop-tag" data-bind="visible: timeline.elapsed > 0">
                                            <span class="prop-name">Elapsed</span>
                                            <span class="prop-value elapsed-time"
                                                data-bind="text: window.wrUtils.toDuration(timeline.elapsed)"></span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <!-- /ko -->
                    </div>
                </div>
            </div>

            <!-- Minimized indicator (shown when minimized) -->
            <div data-bind="if: searchSummaries().length > 0 && searchMinimized()" class="top-margin">
                <div class="alert alert-info">
                    <span data-bind="text: searchResults().length"></span> search results minimized.
                    <a href="#" data-bind="click: toggleSearchMinimized">Show results</a>
                </div>
            </div>

            <!-- No results message -->
            <div data-bind="if: hasSearched() && searchResults().length === 0" class="top-margin">
                <div class="alert alert-info">No jobs found matching your search criteria.</div>
            </div>
        </div>

        <!-- ====================== IN-FLIGHT JOBS SUMMARY ====================== -->
        <div style="width: 100%;" class="well well-sm top-margin">
            <div style="margin: 0 auto;">
                <h5 style="margin: 0; padding: 0">Incomplete <span class="badge"
                        data-bind="text: inflight.total"></span></h5>
                <div class="top-margin" data-bind="if: inflight.total() > 0">
                    <div class="progress" style="margin-bottom: 0">
                        <div class="progress-bar progress-bar-striped active progress-bar-warning" role="progressbar"
                            data-bind="style: { width: inflight.delayPct() + '%' }">
                            <!-- ko if: inflight.delayed() > 0 -->
                            <span data-bind="text: inflight.delayed"></span> delayed
                            <!-- /ko -->
                        </div>
                        <div class="progress-bar progress-bar-striped active progress-bar-warning" role="progressbar"
                            data-bind="style: { width: inflight.dependentPct() + '%' }">
                            <!-- ko if: inflight.dependent() > 0 -->
                            <span data-bind="text: inflight.dependent"></span> dependent
                            <!-- /ko -->
                        </div>
                        <div class="progress-bar progress-bar-striped active progress-bar-info" role="progressbar"
                            data-bind="style: { width: inflight.readyPct() + '%' }">
                            <!-- ko if: inflight.ready() > 0 -->
                            <span data-bind="text: inflight.ready"></span> pending
                            <!-- /ko -->
                        </div>
                        <div class="progress-bar progress-bar-striped active" role="progressbar"
                            data-bind="style: { width: inflight.runPct() + '%' }">
                            <!-- ko if: inflight.running() > 0 -->
                            <span data-bind="text: inflight.running"></span> running
                            <!-- /ko -->
                        </div>
                        <div class="progress-bar progress-bar-striped active progress-bar-danger" role="progressbar"
                            data-bind="style: { width: inflight.lostPct() + '%' }">
                            <!-- ko if: inflight.lost() > 0 -->
                            <span data-bind="text: inflight.lost"></span> lost contact
                            <!-- /ko -->
                        </div>
                        <div class="progress-bar progress-bar-danger" role="progressbar"
                            data-bind="style: { width: inflight.buryPct() + '%' }">
                            <!-- ko if: inflight.buried() > 0 -->
                            <span data-bind="text: inflight.buried"></span> buried
                            <!-- /ko -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====================== REP GROUPS SECTION ====================== -->
        <!-- ko if: sortableRepGroups().length > 0 -->
        <hr>
        <!-- /ko -->

        <div data-bind="foreach: sortableRepGroups().sort(function(l,r) { return l.id > r.id ? 1 : -1 })">
            <div style="width: 100%;" class="well well-sm">
                <div style="margin: 0 auto;" data-bind="attr: { 'data-repgroup': id }">
                    <h5 style="margin: 0; padding: 0">
                        <span data-bind="text: id"></span>
                        <span class="badge" data-bind="text: total"></span>

                        <!-- Close button for search repgroups -->
                        <button type="button" class="btn btn-xs btn-default pull-right"
                            data-bind="visible: id.startsWith('search:'), click: function() { $parent.removeSearchRepGroup(id) }">
                            <span class="glyphicon glyphicon-remove"></span> Close
                        </button>
                    </h5>

                    <div class="top-margin" data-bind="if: total() > 0">
                        <div class="progress" style="margin-bottom: 0">
                            <div class="progress-bar progress-bar-striped active progress-bar-warning"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: delayPct() + '%' }, click: $parent.showRepgroupDelayed, attr: { 'aria-valuenow': delayPct() }"
                                role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: delayed() > 0 -->
                                <span data-bind="text: delayed"></span> delayed
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active progress-bar-warning"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: dependentPct() + '%' }, click: $parent.showRepgroupDependent, attr: { 'aria-valuenow': dependentPct() }"
                                role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: dependent() > 0 -->
                                <span data-bind="text: dependent"></span> dependent
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active progress-bar-info"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: readyPct() + '%' }, click: $parent.showRepgroupReady, attr: { 'aria-valuenow': readyPct() }"
                                role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: ready() > 0 -->
                                <span data-bind="text: ready"></span> pending
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: runPct() + '%' }, click: $parent.showRepgroupRunning, attr: { 'aria-valuenow': runPct() }"
                                role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: running() > 0 -->
                                <span data-bind="text: running"></span> running
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-striped active progress-bar-danger" role="progressbar"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: lostPct() + '%' }, click: $parent.showRepgroupLost, attr: { 'aria-valuenow': lostPct() }"
                                aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: lost() > 0 -->
                                <span data-bind="text: lost"></span> lost contact
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuemin="0"
                                aria-valuemax="100"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: buryPct() + '%' }, click: $parent.showRepgroupBuried, attr: { 'aria-valuenow': buryPct() }">
                                <!-- ko if: buried() > 0 -->
                                <span data-bind="text: buried"></span> buried
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuemin="0"
                                aria-valuemax="100"
                                data-bind="style: { width: deletePct() + '%' }, attr: { 'aria-valuenow': deletePct() }">
                                <!-- ko if: deleted() > 0 -->
                                <span data-bind="text: deleted"></span> <span class="text-muted">(deleted)</span>
                                <!-- /ko -->
                            </div>
                            <div class="progress-bar progress-bar-success"
                                data-bind="css: { 'clickable': id.indexOf('search:') !== 0 }, style: { width: completePct() + '%' }, click: $parent.showRepgroupComplete, attr: { 'aria-valuenow': completePct() }"
                                role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <!-- ko if: complete() > 0 -->
                                <span data-bind="text: complete"></span> complete
                                <!-- /ko -->
                            </div>
                        </div>
                    </div>

                    <!-- ====================== JOB DETAILS PANEL ====================== -->
                    <!-- ko foreach: details -->
                    <div class="top-margin panel" style="margin-bottom: 0"
                        data-bind="css: { 'panel-warning': State == 'delayed' || State == 'dependent', 'panel-info': State == 'ready' || State == 'running', 'panel-danger': State == 'buried' || State == 'lost', 'panel-success': State == 'complete' }">
                        <div class="panel-heading">
                            <div class="terminal"
                                data-bind="css: { 'border-warning': State == 'delayed' || State == 'dependent', 'border-info': State == 'ready', 'border-primary': State == 'running', 'border-danger': State == 'buried' || State == 'lost', 'border-success': State == 'complete' }">
                                <small>
                                    <div class="command-path"
                                        data-bind="attr: {'data-expanded': false}, click: $root.togglePathExpansion">
                                        @<span data-bind="text: Host" style="color: #00FF00;"></span>:
                                        <span data-bind="text: CwdBase" style="color: #FFFF00;"></span><span
                                            data-bind="text: Cwd" style="color:#E5C700"></span>
                                    </div>

                                    <!-- ko if: WithDocker != '' -->
                                    <i>docker image:</i> <span data-bind="text: WithDocker"></span>
                                    <!-- /ko -->
                                    <!-- ko if: WithSingularity != '' -->
                                    <i>singularity image:</i> <span data-bind="text: WithSingularity"></span>
                                    <!-- /ko -->
                                    <!-- ko if: Mounts -->
                                    <i>mounts:</i> <span data-bind="text: Mounts"></span>
                                    <!-- /ko -->
                                    <!-- ko if: ContainerMounts -->
                                    <i>container mounts:</i> <span data-bind="text: ContainerMounts"></span>
                                    <!-- /ko -->
                                </small>

                                <h5 style="margin: 0; padding: 0">$ <span data-bind="text: Cmd"></span></h5>

                                <!-- ko if: StdOut -->
                                <div class="output-divider">
                                    <span class="output-label stdout-label">STDOUT</span>
                                </div>
                                <span data-bind="text: StdOut" class="stdout-text"></span>
                                <!-- /ko -->
                                <!-- ko if: StdErr -->
                                <div class="output-divider">
                                    <span class="output-label stderr-label">STDERR</span>
                                </div>
                                <span data-bind="text: StdErr" class="stderr-text"></span>
                                <!-- /ko -->
                            </div>
                        </div>

                        <!-- ====================== JOB PROPERTIES SECTION ====================== -->
                        <div class="panel-body compact-props">
                            <table class="prop-table">
                                <!-- Core Properties (always visible) -->
                                <tr class="prop-row">
                                    <td class="prop-title">Resources:</td>
                                    <td class="prop-content">
                                        <div class="prop-tag">
                                            <span class="prop-name">Cores</span>
                                            <span class="prop-value" data-bind="text: Cores"></span>
                                        </div>

                                        <div class="prop-tag">
                                            <span class="prop-name">RAM</span>
                                            <span class="prop-value">
                                                <span data-bind="text: window.wrUtils.mbIEC(ExpectedRAM)"></span>
                                                <!-- ko if: Exited && PeakRAM > 0 -->
                                                <span class="prop-separator">→</span>
                                                <span class="actual-value"
                                                    data-bind="text: window.wrUtils.mbIEC(PeakRAM), css: { 'over-limit': PeakRAM > ExpectedRAM }"></span>
                                                <!-- /ko -->
                                            </span>
                                        </div>

                                        <div class="prop-tag">
                                            <span class="prop-name">Time</span>
                                            <span class="prop-value">
                                                <span data-bind="text: window.wrUtils.toDuration(ExpectedTime)"></span>

                                                <!-- ko if: Exited -->
                                                <span class="prop-separator">→</span>
                                                <span class="actual-value"
                                                    data-bind="text: window.wrUtils.toDuration(Walltime), css: { 'over-limit': Walltime > ExpectedTime }"></span>
                                                <span class="prop-separator">•</span>
                                                <span
                                                    data-bind="text: 'CPU: ' + window.wrUtils.toDuration(CPUtime)"></span>
                                                <!-- /ko -->

                                                <!-- ko if: !Exited && (State == 'running' || State == 'reserved') -->
                                                <span class="prop-separator">→</span>
                                                <span class="actual-value"
                                                    data-bind="text: window.wrUtils.toDuration(LiveWalltime()), css: { 'over-limit': LiveWalltime() > ExpectedTime }"></span>
                                                <!-- /ko -->

                                                <!-- ko if: !Exited && State == 'lost' -->
                                                <span class="prop-separator">→</span>
                                                <span class="actual-value"
                                                    data-bind="text: window.wrUtils.toDuration(Walltime), css: { 'over-limit': Walltime > ExpectedTime }"></span>
                                                <!-- /ko -->
                                            </span>
                                        </div>

                                        <!-- Disk -->
                                        <div class="prop-tag" data-bind="if: RequestedDisk > 0 || PeakDisk > 0">
                                            <span class="prop-name">Disk</span>
                                            <span class="prop-value">
                                                <span data-bind="text: RequestedDisk + ' GB'"></span>
                                                <!-- ko if: Exited -->
                                                <span class="prop-separator">→</span>
                                                <span class="actual-value"
                                                    data-bind="text: PeakDisk === 0 ? '0GB' : window.wrUtils.mbIEC(PeakDisk), css: { 'over-limit': RequestedDisk > 0 && PeakDisk > RequestedDisk*1024 }"></span>
                                                <!-- /ko -->
                                            </span>
                                        </div>

                                        <!-- Docker (conditional) -->
                                        <!-- ko if: MonitorDocker != '' -->
                                        <div class="prop-tag">
                                            <span class="prop-name">Docker</span>
                                            <span class="prop-value" data-bind="text: MonitorDocker"></span>
                                        </div>
                                        <!-- /ko -->
                                    </td>
                                </tr>

                                <!-- Combined status section -->
                                <tr class="prop-row">
                                    <td class="prop-title">Status:</td>
                                    <td class="prop-content">
                                        <div class="prop-tag">
                                            <span class="prop-name">Attempts</span>
                                            <span class="prop-value" data-bind="text: Attempts"></span>
                                        </div>

                                        <!-- Exit code, only visible when job has exited -->
                                        <!-- ko if: Exited -->
                                        <div class="prop-tag">
                                            <span class="prop-name">Exit</span>
                                            <span class="prop-value">
                                                <span data-bind="text: Exitcode"></span>
                                            </span>
                                        </div>
                                        <!-- /ko -->

                                        <!-- Failure reason as separate tag, only visible when there is a reason -->
                                        <!-- ko if: FailReason -->
                                        <div class="prop-tag">
                                            <span class="prop-name">Reason</span>
                                            <span class="prop-value">
                                                <span data-bind="text: FailReason, attr: { title: FailReason }"></span>
                                            </span>
                                        </div>
                                        <!-- /ko -->
                                    </td>
                                </tr>

                                <!-- Execution information -->
                                <tr class="prop-row">
                                    <td class="prop-title">Execution:</td>
                                    <td class="prop-content">
                                        <!-- ko if: Started -->
                                        <div class="prop-tag">
                                            <span class="prop-name">When</span>
                                            <span class="prop-value">
                                                <span
                                                    data-bind="text: 'Started: ' + window.wrUtils.toDate(Started)"></span>
                                                <!-- ko if: Exited -->
                                                <span class="prop-separator">→</span>
                                                <span data-bind="text: 'Ended: ' + window.wrUtils.toDate(Ended)"></span>
                                                <!-- /ko -->
                                            </span>
                                        </div>
                                        <!-- /ko -->

                                        <!-- ko if: Host -->
                                        <div class="prop-tag">
                                            <span class="prop-name">Where</span>
                                            <span class="prop-value">
                                                <span data-bind="text: Host"></span>
                                                <span class="prop-separator">•</span>
                                                <span data-bind="text: 'IP: ' + HostIP"></span>
                                                <!-- ko if: HostID != "" -->
                                                <span class="prop-separator">•</span>
                                                <span data-bind="text: 'ID: ' + HostID"></span>
                                                <!-- /ko -->
                                                <span class="prop-separator">•</span>
                                                <span data-bind="text: 'PID: ' + Pid"></span>
                                            </span>
                                        </div>
                                        <!-- /ko -->

                                        <div class="prop-tag clickable details-button"
                                            data-bind="click: $root.showJobDetails">
                                            <span class="prop-name">Details</span>
                                            <span class="prop-value"><i
                                                    class="glyphicon glyphicon-info-sign"></i></span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- ====================== JOB ACTION BUTTONS ====================== -->
                        <div class="panel-footer clearfix">
                            <!-- ko if: Similar > 0 -->
                            <span class="load-more-section">
                                <button type="button" class="btn btn-sm btn-info load-more-btn"
                                    data-bind="click: function(data, event) { $root.loadMoreJobs(data, event) }">
                                    <!-- ko if: Exitcode <= 0 -->
                                    Load more commands
                                    <!-- /ko -->
                                    <!-- ko if: Exitcode > 0 -->
                                    Load more commands with the same exit code and failure reason
                                    <!-- /ko -->
                                </button>
                            </span>
                            <!-- /ko -->
                            <!-- ko if: State == "delayed" -->
                            <button type="button" class="btn btn-danger pull-right"
                                data-bind="click: $root.confirmRemoveDelay">Remove</button>
                            <!-- /ko -->
                            <!-- ko if: State == "ready" -->
                            <button type="button" class="btn btn-danger pull-right"
                                data-bind="click: $root.confirmRemovePend">Remove</button>
                            <!-- /ko -->
                            <!-- ko if: State == "dependent" -->
                            <button type="button" class="btn btn-danger pull-right"
                                data-bind="click: $root.confirmRemoveDep">Remove</button>
                            <!-- /ko -->
                            <!-- ko if: State == "running" -->
                            <button type="button" class="btn btn-danger pull-right"
                                data-bind="click: $root.confirmKill">Kill</button>
                            <!-- /ko -->
                            <!-- ko if: State == "lost" -->
                            <small>This job appears dead, but this could be due to a temporary issue such as a
                                networking failure; if the job is actually fine, it will revert to running state
                                automatically when the problem is fixed.</small><br>
                            <button type="button" class="btn btn-danger pull-right"
                                data-bind="click: $root.confirmDead">Confirm Dead</button>
                            <!-- /ko -->
                            <!-- ko if: State == "buried" -->
                            <div class="btn-group pull-right">
                                <button type="button" class="btn btn-danger"
                                    data-bind="click: $root.confirmRemoveFail">Remove</button>
                                <button type="button" class="btn btn-primary"
                                    data-bind="click: $root.confirmRetry">Retry</button>
                            </div>
                            <!-- /ko -->
                        </div>
                    </div>
                    <!-- /ko -->
                </div>
            </div>
        </div>

        <!-- ====================== MODAL DIALOGS ====================== -->
        <!-- action modals - keep this separate -->
        <div data-bind="modal: {
                visible: actionModalVisible,
                dialogCss: 'modal-sm',
                header: { data: { label: actionModalHeader } },
                body: { name: 'actionModalBodyTemplate', data: actionDetails },
                footer: { name: 'actionModalFooterTemplate', data: actionDetails }
            }"></div>
        <script type="text/html" id="actionModalBodyTemplate">
                <!-- ko if: button() != "confirm" -->
                Are you sure you want to <span data-bind="text: action"></span> the <span data-bind="text: count"></span>
        commands with the identifier "<span data-bind="text: repGroup"></span>"
        <!-- ko if: exited -->
        that had exit code <span data-bind="text: exitCode"></span> and failed because "<span
            data-bind="text: failReason"></span>"?
        <!-- /ko -->
        <!-- ko if: ! exited -->
        ?
        <!-- /ko -->
        <!-- /ko -->
        <!-- ko if: button() == "confirm" -->
        Are you sure the <span data-bind="text: count"></span> commands with the identifier "<span
            data-bind="text: repGroup"></span>" are really dead?
        <!-- /ko -->
        <br>
        <!-- ko if: button() == "kill" -->
        <small>(there will be a delay before the cmds stop executing; after killing wait until the jobs become
            buried)</small>
        <!-- /ko -->
        <!-- ko if: button() == "remove" -->
        <small>(removal of commands that have other commands depending on them will silently fail)</small>
        <!-- /ko -->
        </script>
        <script type="text/html" id="actionModalFooterTemplate">
            <div class="btn-group">
                <!-- ko if: count() > 1 -->
                    <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, true), text: $root.capitalizeFirstLetter(button()) + ' all'"></button>
                    <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, false), text: $root.capitalizeFirstLetter(button()) + ' 1'"></button>
                <!-- /ko -->
                <!-- ko if: count() == 1 -->
                    <button type="button" class="btn btn-primary" data-bind="click: $root.commitAction.bind($data, false), text: $root.capitalizeFirstLetter(button())"></button>
                <!-- /ko -->
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </script>

        <!-- Single combined misc job details modal -->
        <div data-bind="modal: {
                visible: jobDetailsModalVisible,
                dialogCss: 'modal-lg',
                header: { data: { label: 'Execution Details' } },
                body: { name: 'jobDetailsModalBodyTemplate', data: jobDetailsData }
            }"></div>

        <script type="text/html" id="jobDetailsModalBodyTemplate">
            <!-- ko if: $data -->
        <div class="job-details-container">
            <!-- Internal Job ID Section -->
            <div class="details-section">
                <h4 class="details-heading">Internal Job ID</h4>
                <div class="details-content" data-bind="text: Key"></div>
            </div>

            <!-- Limit Groups Section -->
            <!-- ko if: LimitGroups && LimitGroups.length > 0 -->
            <div class="details-section">
                <h4 class="details-heading">Limit Groups</h4>
                <div class="details-content" data-bind="text: LimitGroups.join('<br>')"></div>
            </div>
            <!-- /ko -->

            <!-- Dependency Groups Section -->
            <!-- ko if: DepGroups && DepGroups.length > 0 -->
            <div class="details-section">
                <h4 class="details-heading">Dependency Groups</h4>
                <div class="details-content" data-bind="text: DepGroups.join('<br>')"></div>
            </div>
            <!-- /ko -->

            <!-- Dependencies Section -->
            <!-- ko if: Dependencies && Dependencies.length > 0 -->
            <div class="details-section">
                <h4 class="details-heading">Dependencies</h4>
                <div class="details-content" data-bind="text: Dependencies.join('<br>')"></div>
            </div>
            <!-- /ko -->

            <!-- Behaviours Section -->
            <!-- ko if: Behaviours -->
            <div class="details-section">
                <h4 class="details-heading">Behaviours</h4>
                <div class="details-content" data-bind="text: Behaviours"></div>
            </div>
            <!-- /ko -->

            <!-- Other Requirements Section -->
            <!-- ko if: OtherRequests && OtherRequests.length > 0 -->
            <div class="details-section">
                <h4 class="details-heading">Other Requirements</h4>
                <div class="details-content" data-bind="text: OtherRequests.join('<br>')"></div>
            </div>
            <!-- /ko -->

            <!-- Environment Variables Section -->
            <!-- ko if: Env && Env.length > 0 -->
            <div class="details-section">
                <h4 class="details-heading">Environment Variables</h4>
                <div class="details-content" data-bind="html: Env.join('<br>')"></div>
            </div>
            <!-- /ko -->
        </div>
        <!-- /ko -->

        <!-- ko ifnot: $data -->
        <div class="alert alert-info">No details available for this job.</div> <button type="button" class="close"
            data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <!-- /ko -->
        <h4 class="modal-title" id="resourceChartModalLabel">Resource Usage Analysis</h4>
        </script>

    </div>
    <div class="modal-body">
        <!-- Resource Visualization Modal -->
        <div class="modal fade" id="resourceChartModal" tabindex="-1" role="dialog"
            aria-labelledby="resourceChartModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="resourceChartModalLabel">Resource Usage Analysis</h4>
                    </div>
                    <div class="modal-body">
                        <!-- Fix: Increase height and add margin-bottom for chart container -->
                        <div class="chart-container"
                            style="position: relative; height:420px; width:100%; margin-bottom: 30px">
                            <canvas id="resourceChart"></canvas>
                        </div>
                        <div id="chartStats" class="small text-muted"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- ====================== FOOTER ====================== -->
        <footer id="footer">
            <small>&copy; 2016-2025 Genome Research Limited.</small>
        </footer>
    </div>
</body>

</html>